# DeepSeek RAG 应用测试指南

本文档提供完整的测试流程和测试用例，帮助你验证应用的所有功能。

## 测试环境确认

### 前置检查清单
- [ ] Python 3.9+ 已安装
- [ ] 所有依赖已安装 (`pip list | grep streamlit`)
- [ ] `.env` 文件已配置且包含有效的 `DEEPSEEK_API_KEY`
- [ ] 网络连接正常（可访问 api.deepseek.com）
- [ ] 4GB+ 内存可用（用于 BGE 模型）

### 启动应用

```bash
# Windows
run.bat

# Linux/macOS
export PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION=python
python -m streamlit run app.py
```

等待应用完全加载（约 8-10 秒），浏览器自动打开 `http://localhost:8501`

---

## 测试用例 1: 基础聊天功能

**目标**: 验证不使用 RAG 的基础聊天功能

### 步骤

1. **检查应用状态**
   - 左侧边栏应显示：
     - ✅ "DeepSeek API 已连接"
     - ✅ "RAG 服务已就绪"
   - 知识库显示：0 文档（初始状态）

2. **禁用 RAG**
   - 在侧边栏找到"🔍 RAG 知识库"部分
   - 将"启用 RAG 知识库"的开关设为 **OFF**（禁用状态）

3. **发送简单问题**
   - 在底部输入框输入：`你好，今天天气怎么样？`
   - 按 Enter 或点击发送按钮
   - 观察：
     - 消息应立即出现在聊天区域（用户消息）
     - AI 回复应逐 Token 流式显示（带光标 ▌）
     - 最终光标消失，显示完整回复

4. **验证参数调整**
   - 在侧边栏调整"温度"从 0.7 改为 0.2
   - 再次输入问题：`讲一个短笑话`
   - 观察：回复应该更有确定性、更直接（不会太创意）
   - 将温度改为 1.5，重复步骤
   - 观察：回复应该更有创意性

5. **验证最大 Token 数**
   - 将最大 Token 设为 256
   - 输入：`请详细解释什么是人工智能`
   - 观察：回复应该被截断（比较短）
   - 改为 2048 重复
   - 观察：回复应该更完整和详细

**预期结果**: ✅ 成功
- 聊天正常显示
- 参数影响可观察
- 流式响应效果良好

---

## 测试用例 2: 知识库上传功能

**目标**: 验证文档上传和处理

### 准备测试文档

创建测试 TXT 文件 `test_document.txt`：

```txt
《Python 编程基础》

第一章 什么是 Python

Python 是一种高级的、通用的、面向对象的编程语言。由于其简单易学的特点，
它被广泛应用于数据科学、人工智能、Web 开发和系统运维等领域。

Python 的特点：
1. 简单易学：Python 的语法接近自然语言
2. 强大的库：拥有丰富的标准库和第三方库
3. 跨平台：可在 Windows、Linux、macOS 等系统运行
4. 开源免费：Python 是完全开源的
5. 活跃社区：拥有世界上最活跃的开发者社区

第二章 安装 Python

在 Windows 系统上安装 Python 非常简单：
1. 访问 python.org 官方网站
2. 下载最新版本的 Python 安装程序
3. 运行安装程序，记得勾选"Add Python to PATH"选项
4. 完成安装后，在命令行输入 "python --version" 确认安装成功

推荐安装 Python 3.9 或更新版本。
```

保存为 `D:\projects\rag\data\test_document.txt`

### 步骤

1. **转到知识库管理标签页**
   - 点击顶部"📚 知识库管理"标签

2. **验证初始状态**
   - 应显示三个指标：
     - 文档数量: 0
     - 检索 Top-K: 5
     - 状态: empty

3. **上传文档**
   - 在"📄 上传文档"部分，点击"选择文件"或拖拽文件
   - 选择 `test_document.txt`
   - 点击"添加到知识库"按钮

4. **验证上传过程**
   - 应看到进度条显示处理进度
   - 应显示消息：`处理文件 1/1: test_document.txt`
   - 等待处理完成（通常 5-10 秒）

5. **验证上传成功**
   - 应看到成功消息：`✅ 成功添加 X 个文本块`（X 应该是分块数量，约 5-8 块）
   - 知识库统计更新：
     - 文档数量: 应显示数字（>0）
     - 状态: 应改为 "ready"

6. **测试多文件上传**
   - 创建第二个测试文件 `test_document2.txt`
   - 选择多个文件
   - 再次点击"添加到知识库"
   - 验证文档数量增加

**预期结果**: ✅ 成功
- 文档成功上传
- 知识库统计更新
- 进度条显示正确

---

## 测试用例 3: RAG 检索功能

**目标**: 验证 RAG 是否能正确检索和使用知识库文档

### 前提条件
- 已完成测试用例 2，知识库中有文档

### 步骤

1. **转到对话标签页**
   - 点击顶部"💬 对话"标签

2. **启用 RAG**
   - 确保侧边栏"启用 RAG 知识库"开关为 **ON**（启用）

3. **提问相关知识库内容**
   - 输入问题：`Python 有什么特点？`
   - 按 Enter 发送
   - 观察 AI 回复：
     - 应该参考上传的文档内容
     - 可能会看到类似"【文档 X】"的引用
     - 回复应该提到 Python 的特点（简单易学、强大的库等）

4. **验证 RAG 上下文**
   - 查看返回的回复，应包含来自知识库文档的信息
   - 回复应该比单纯使用模型知识更具体

5. **对比：禁用 RAG 的回复**
   - 关闭"启用 RAG 知识库"开关
   - 输入相同问题：`Python 有什么特点？`
   - 观察区别：
     - 没有 RAG 的回复可能更泛泛而谈
     - 可能不会提到文档中的具体内容

6. **测试知识库以外的问题**
   - 启用 RAG
   - 输入问题：`今天天气怎么样？`（文档中不包含此内容）
   - 观察：AI 应该使用通用知识回答，因为知识库没有相关信息

**预期结果**: ✅ 成功
- RAG 正确检索文档
- 启用/禁用 RAG 有明显区别
- 回复质量提高

---

## 测试用例 4: 流式输出验证

**目标**: 验证 Token 流式输出效果

### 步骤

1. **启用 RAG，确保有文档**

2. **输入会产生较长回复的问题**
   - `详细解释 Python 的优势和应用领域`

3. **观察输出效果**
   - 回复应该逐 Token 显示（不是一次性显示）
   - 应该看到实时更新效果（光标 ▌ 跟随）
   - 最终光标消失
   - 回复应该自动添加到聊天历史

**预期结果**: ✅ 成功
- 流式输出清晰可见
- 输出速度正常（~40-80 token/秒）
- 最终结果保存到历史

---

## 测试用例 5: 对话历史管理

**目标**: 验证对话历史的保存和管理

### 步骤

1. **发送多条消息**
   - 消息 1: `你好`
   - 消息 2: `Python 是什么？`
   - 消息 3: `我可以用它做什么？`

2. **验证历史显示**
   - 所有消息应该显示在聊天区域
   - 用户消息应该右对齐，AI 消息左对齐
   - 应该能看到完整的对话流程

3. **验证聊天 Token 计数**
   - 侧边栏应显示"消息数量"和"估计 Token"
   - 消息数量应该增加（按用户消息数计数）
   - Token 数应该随着对话增加而增加

4. **清空对话历史**
   - 点击侧边栏"🗑️ 清空对话历史"按钮
   - 应看到确认消息：`✅ 对话历史已清空`
   - 聊天区域应变空
   - 消息数量应重置为 0

**预期结果**: ✅ 成功
- 历史正确显示
- 统计数据准确
- 清空功能有效

---

## 测试用例 6: 知识库清空功能

**目标**: 验证知识库清空操作

### 步骤

1. **转到知识库管理标签页**

2. **验证当前知识库**
   - 应显示有文档（从测试用例 2 上传）

3. **清空知识库**
   - 在"⚠️ 危险操作"部分
   - 点击"🗑️ 清空知识库"按钮
   - 应看到确认消息：`✅ 知识库已清空`

4. **验证清空效果**
   - 知识库统计应更新：
     - 文档数量: 0
     - 状态: empty
   - RAG 检索应返回无结果

**预期结果**: ✅ 成功
- 知识库成功清空
- 统计数据更新
- RAG 检索不可用

---

## 性能测试

### 测试用例 7: 模型加载时间

**步骤**
1. 重启应用
2. 记录从"Starting DeepSeek AI Chat"到界面完全加载的时间
3. 应该在 8-10 秒内完成

**预期结果**: ✅ <15 秒

### 测试用例 8: 向量化性能

**步骤**
1. 上传包含约 5000 字的文档
2. 记录"处理文件"到"成功添加"的时间

**预期结果**: ✅ <10 秒

### 测试用例 9: 检索速度

**步骤**
1. 发送一条 RAG 查询
2. 记录从提交到收到 AI 回复的时间

**预期结果**: ✅ <15 秒（包括 API 调用）

---

## 错误恢复测试

### 测试用例 10: 网络断开恢复

**步骤**
1. 在 AI 回复中途断开网络
2. 观察应用是否显示错误消息
3. 恢复网络连接
4. 尝试重新发送消息
5. 验证应用是否恢复正常

**预期结果**: ✅ 显示友好错误消息，能恢复

### 测试用例 11: 无效文件处理

**步骤**
1. 尝试上传图片文件（.jpg）或其他不支持的格式
2. 观察应用响应

**预期结果**: ✅ 文件不被接受或显示处理错误

---

## 日志验证

### 检查日志文件

```bash
# 查看最近日志
tail -f logs/app.log

# 查找特定操作的日志
grep "RAG" logs/app.log
grep "Error" logs/app.log
```

### 应该看到的日志条目

```
2025-12-25 HH:MM:SS | INFO    | BGE model loaded successfully
2025-12-25 HH:MM:SS | INFO    | Memory KB Handler initialized
2025-12-25 HH:MM:SS | INFO    | RAG Service initialized
2025-12-25 HH:MM:SS | DEBUG   | Adding X documents to memory KB
2025-12-25 HH:MM:SS | INFO    | Successfully added X documents
2025-12-25 HH:MM:SS | DEBUG   | Retrieving top 5 documents for query
```

---

## 综合测试检查清单

- [ ] 应用正常启动
- [ ] API 连接成功
- [ ] 基础聊天正常
- [ ] 参数调整有效
- [ ] 文档上传成功
- [ ] 知识库统计更新
- [ ] RAG 检索有效
- [ ] 启用/禁用 RAG 有区别
- [ ] 流式输出正常
- [ ] 对话历史保存
- [ ] 消息计数准确
- [ ] 清空对话历史有效
- [ ] 知识库清空有效
- [ ] 性能指标达标
- [ ] 无控制台错误

---

## 故障排除

### 如果测试失败

1. **查看日志**
   ```bash
   tail -100 logs/app.log
   ```

2. **检查 .env 配置**
   ```bash
   cat .env | grep -v "^#"
   ```

3. **验证网络连接**
   ```bash
   ping api.deepseek.com
   ```

4. **重启应用**
   ```bash
   # 关闭当前运行 (Ctrl+C)
   # 重新启动
   python -m streamlit run app.py
   ```

5. **清理缓存**
   ```bash
   # 删除 Streamlit 缓存
   rm -rf ~/.streamlit
   python -m streamlit run app.py
   ```

---

**测试完成后**: 如果所有测试都通过，恭喜！应用已准备好用于生产环境。
