# 🏗️ 系统架构详解

## 阶段 1 - 基础对话架构

### 整体系统流程

```
┌────────────────────────────────────────────────────────────────┐
│                     用户 (浏览器)                              │
└────────────────────────────────────────────────────────────────┘
                          ▲
                          │ HTTP
                          ▼
┌────────────────────────────────────────────────────────────────┐
│                    Streamlit 服务                              │
│  ┌────────────────────────────────────────────────────────┐   │
│  │              Streamlit App (app.py)                   │   │
│  │  ┌──────────────────────────────────────────────────┐ │   │
│  │  │ 1. 对话界面                                    │ │   │
│  │  │    - 消息显示                                 │ │   │
│  │  │    - 输入框                                   │ │   │
│  │  │    - 流式响应                                 │ │   │
│  │  └──────────────────────────────────────────────────┘ │   │
│  │  ┌──────────────────────────────────────────────────┐ │   │
│  │  │ 2. 侧边栏                                      │ │   │
│  │  │    - 参数调整（温度、Token 数）               │ │   │
│  │  │    - 统计信息                                 │ │   │
│  │  │    - 控制功能                                 │ │   │
│  │  └──────────────────────────────────────────────────┘ │   │
│  └────────────────────────────────────────────────────────┘   │
│                          │                                     │
│                          ▼                                     │
│  ┌────────────────────────────────────────────────────────┐   │
│  │         DeepSeekClient (src/deepseek_client.py)        │   │
│  │  ┌──────────────────────────────────────────────────┐ │   │
│  │  │ 1. 初始化                                      │ │   │
│  │  │    - 验证 API Key                             │ │   │
│  │  │    - 创建 OpenAI 客户端                       │ │   │
│  │  └──────────────────────────────────────────────────┘ │   │
│  │  ┌──────────────────────────────────────────────────┐ │   │
│  │  │ 2. 对话方法                                    │ │   │
│  │  │    - chat() 同步对话                          │ │   │
│  │  │    - chat_stream() 流式对话                   │ │   │
│  │  └──────────────────────────────────────────────────┘ │   │
│  │  ┌──────────────────────────────────────────────────┐ │   │
│  │  │ 3. Token 管理                                  │ │   │
│  │  │    - count_tokens_estimate()                  │ │   │
│  │  │    - count_messages_tokens()                  │ │   │
│  │  └──────────────────────────────────────────────────┘ │   │
│  └────────────────────────────────────────────────────────┘   │
│                          │                                     │
│                          ▼                                     │
│  ┌────────────────────────────────────────────────────────┐   │
│  │              配置管理 (config.py)                      │   │
│  │  ┌──────────────────────────────────────────────────┐ │   │
│  │  │ 1. 环境变量加载                                │ │   │
│  │  │    - DEEPSEEK_API_KEY                         │ │   │
│  │  │    - DEEPSEEK_BASE_URL                        │ │   │
│  │  │    - 应用配置参数                             │ │   │
│  │  └──────────────────────────────────────────────────┘ │   │
│  │  ┌──────────────────────────────────────────────────┐ │   │
│  │  │ 2. 日志配置                                    │ │   │
│  │  │    - 日志级别                                 │ │   │
│  │  │    - 日志输出路径                             │ │   │
│  │  └──────────────────────────────────────────────────┘ │   │
│  └────────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────────┘
                          ▲
                          │ HTTPS
                          ▼
┌────────────────────────────────────────────────────────────────┐
│                  DeepSeek API 服务                             │
│  https://api.deepseek.com/v1                                  │
└────────────────────────────────────────────────────────────────┘
```

### 数据流和消息序列

```
用户输入 "你好"
    │
    ▼
1. Streamlit 接收输入
   └─ st.chat_input() 捕获消息
   └─ 保存到 st.session_state.messages
    │
    ▼
2. 调用 handle_user_input()
   └─ 验证 API 客户端就绪
   └─ 提取聊天历史（只取内容和角色）
    │
    ▼
3. 调用 DeepSeekClient.chat_stream()
   │
   ├─ 创建 OpenAI 客户端请求
   │  {
   │    "model": "deepseek-chat",
   │    "messages": [{"role": "user", "content": "你好"}],
   │    "stream": true
   │  }
   │
   └─ 发送到 https://api.deepseek.com/v1/chat/completions
    │
    ▼
4. API 返回流式响应
   └─ chunk 1: "你"
   └─ chunk 2: "好"
   └─ chunk 3: "，"
   └─ ...
    │
    ▼
5. Streamlit 实时显示
   ├─ 创建占位符
   ├─ 不断更新占位符内容
   │  "你" → "你好" → "你好，" → ...
   └─ 显示打字光标 "▌"
    │
    ▼
6. 响应完成
   ├─ 移除光标
   ├─ 保存完整响应到历史
   └─ 更新统计信息
```

## 阶段 2 - RAG 扩展架构（规划）

### 完整的 RAG 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                    用户界面层                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────┐     ┌──────────────────────┐     │
│  │  对话界面           │     │  知识库管理          │     │
│  │  - 消息显示         │     │  - 文档上传          │     │
│  │  - 实时流式输出     │     │  - 知识库浏览        │     │
│  │  - 参数调整         │     │  - 删除文档          │     │
│  └─────────────────────┘     └──────────────────────┘     │
│                                                             │
└────────────────────────┬────────────────────────────────────┘
                         │
        ┌────────────────┼────────────────┐
        ▼                ▼                ▼
   ┌─────────────┐  ┌──────────────┐  ┌─────────────┐
   │ RAG Service │  │ 文档处理      │  │ Embedding   │
   │ (融合层)    │  │ (处理层)      │  │ Handler     │
   │             │  │              │  │ (向量化)    │
   │ - 检索增强  │  │ - PDF 解析    │  │             │
   │ - 提示词    │  │ - 文本分割    │  │ - BGE 模型  │
   │   构建      │  │ - 清理规范    │  │ - 缓存      │
   │             │  │              │  │ - GPU/CPU   │
   └─────────────┘  └──────────────┘  └─────────────┘
        │                │                   │
        └────────────────┼───────────────────┘
                         ▼
               ┌──────────────────────┐
               │  ChromaDB Handler    │
               │  (知识库层)          │
               │                      │
               │ - 添加文档           │
               │ - 检索相似文档       │
               │ - 更新/删除          │
               │ - 持久化存储         │
               └──────────────────────┘
                         │
        ┌────────────────┼────────────────┐
        ▼                ▼                ▼
   ┌─────────────┐  ┌──────────────┐  ┌─────────────┐
   │ ChromaDB    │  │ 向量索引     │  │ 元数据      │
   │ 数据库      │  │ (HNSW)       │  │ 存储        │
   │ (.db)       │  │              │  │             │
   └─────────────┘  └──────────────┘  └─────────────┘
```

### 完整的对话流程（包含 RAG）

```
用户: "文档中说什么？"
│
▼
1. Streamlit 接收输入
│
▼
2. 决定是否使用 RAG
   ├─ 如果 use_rag == True:
   │  │
   │  ▼
   │  3. RAG 检索流程
   │  │
   │  ├─ 3.1 将查询向量化
   │  │      query_embedding = embedding_handler.embed_query("文档中说什么？")
   │  │      → 384 维向量
   │  │
   │  ├─ 3.2 在 ChromaDB 中检索相似文档
   │  │      results = chroma_handler.retrieve(query, top_k=5)
   │  │      → 返回 Top-5 相似文档
   │  │
   │  ├─ 3.3 格式化检索结果
   │  │      context = "相关文档：\n- 文档1：...\n- 文档2：..."
   │  │
   │  └─ 3.4 构建增强提示词
   │         prompt = """
   │         你是有用的 AI 助手。
   │         基于以下相关信息回答：
   │         {context}
   │         用户问题：{query}
   │         """
   │
   └─ 如果 use_rag == False:
      └─ 跳过 RAG，直接对话
│
▼
4. 调用 DeepSeek API
   ├─ 发送增强的消息列表
   ├─ 包含对话历史
   └─ 流式接收响应
│
▼
5. 实时显示回复
│
▼
6. 保存到历史
```

## 模块化设计

### 依赖关系图

```
app.py
  │
  ├─ Streamlit (UI)
  │
  ├─ config.py (配置)
  │  └─ .env (环境变量)
  │
  └─ src/deepseek_client.py (API)
      └─ OpenAI (HTTP)
          └─ DeepSeek API (远程)
```

### 阶段 2 依赖关系

```
app.py
  │
  ├─ config.py
  │
  ├─ src/deepseek_client.py
  │
  ├─ src/rag_service.py (新增)
  │  │
  │  ├─ src/embedding_handler.py
  │  │  └─ FlagEmbedding (BGE 模型)
  │  │
  │  ├─ src/chroma_handler.py
  │  │  └─ chromadb
  │  │
  │  └─ src/document_processor.py
  │     ├─ langchain
  │     ├─ PyPDF2
  │     └─ python-docx
  │
  └─ prompts/system_prompts.py
```

## 内存管理

### Session State 结构

```
st.session_state = {
    "messages": [
        {
            "role": "user",
            "content": "你好",
            "timestamp": "2024-12-25T10:30:00"
        },
        {
            "role": "assistant",
            "content": "你好！有什么我可以帮你的吗？",
            "timestamp": "2024-12-25T10:30:05"
        },
        ...
    ],
    "deepseek_client": <DeepSeekClient>,
    "chat_input": ""  # 输入框值
}
```

### 内存占用估算

| 组件 | 内存 | 说明 |
|------|------|------|
| Streamlit 基础 | ~100 MB | 框架本身 |
| 20 条消息 | ~5 MB | 约 50KB/条 |
| DeepSeek 客户端 | ~1 MB | API 连接 |
| BGE 模型（阶段2） | ~1.5 GB | 向量模型 |
| ChromaDB（阶段2） | 变化 | 取决于文档数 |
| **总计（阶段1）** | **~100-110 MB** | **正常** |
| **总计（阶段2）** | **~1.6-1.7 GB** | **需要 GPU** |

## 网络通信

### API 请求/响应示例

#### 请求格式
```json
{
  "model": "deepseek-chat",
  "messages": [
    {
      "role": "user",
      "content": "你好"
    }
  ],
  "stream": true,
  "temperature": 0.7,
  "max_tokens": 2048
}
```

#### 流式响应示例
```
data: {"choices":[{"delta":{"content":"你"}}]}
data: {"choices":[{"delta":{"content":"好"}}]}
data: {"choices":[{"delta":{"content":"！"}}]}
...
data: [DONE]
```

## 性能指标

### 响应时间分解

```
用户输入
   │
   ├─ Streamlit 处理：0-10ms
   │
   ├─ 网络延迟（国内）：50-200ms
   │
   ├─ DeepSeek 处理时间：
   │  ├─ Token 化：10-50ms
   │  ├─ 模型推理：500-2000ms
   │  └─ 编码：10-50ms
   │
   └─ 网络传输和渲染：100-500ms
   │
   ▼
总计：~800-2800ms
```

### 流量估算

| 请求类型 | 大小 | 频率 |
|---------|------|------|
| 简单请求 | ~200 bytes | 每条消息 |
| 流式响应 | ~5KB | 每条回复 |
| 日志写入 | ~100 bytes | 每次操作 |

## 安全考虑

### 数据流安全

```
用户 ─(HTTPS)─> Streamlit ─(HTTPS)─> DeepSeek API
                    │
                    └─> 本地日志文件（敏感信息已过滤）
```

### 敏感信息保护

- ✅ API Key 存储在 .env 文件（不提交到 Git）
- ✅ 日志中不记录完整的消息内容
- ✅ Session 中的数据仅在内存（刷新后清空）
- ⚠️ 建议：生产环境使用密钥管理服务

## 扩展性考虑

### 水平扩展（多用户）

当前架构限制：
- 单一 Streamlit 服务器
- 内存中的 session state
- 无用户认证

扩展方案：
- 使用 Streamlit Cloud / Docker
- 添加数据库持久化
- 实现用户认证系统
- 使用 Redis 共享 session

### 垂直扩展（功能）

阶段 2 之后的可能扩展：
- 多 LLM 模型支持
- 多知识库管理
- 插件系统
- API 服务化

---

**架构文档版本：1.0**
**最后更新：2024-12-25**
